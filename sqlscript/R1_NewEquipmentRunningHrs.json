{
	"name": "R1_NewEquipmentRunningHrs",
	"properties": {
		"description": "summary WorkingHours",
		"content": {
			"query": "CREATE OR ALTER PROCEDURE ExecuteR1Query AS\nBEGIN\n    -- R1 Query Logic\n    WITH NextEvent AS (\n        SELECT x1.cheID,\n               x1.operator_name,\n               x1.type_description AS EcEventType,\n               x1.timestamp,\n               x2.operator_name AS NextOperator,\n               x2.type_description AS NextEcEvent,\n               x2.timestamp AS NextEcEventTimestamp,\n               CASE \n                   WHEN x1.type_description = x2.type_description THEN 'NO' \n                   ELSE 'YES' \n               END AS CorrectCycle\n        FROM dbo.ecevents x1\n        LEFT JOIN dbo.ecevents x2 \n               ON x1.cheID = x2.cheID\n              AND x2.timestamp > x1.timestamp\n              AND x2.type_description IN ('LGON', 'LGOF')\n        WHERE x1.type_description = 'LGON'\n    )\n    SELECT ne.cheID,\n           ne.operator_name,\n           ne.EcEventType,\n           ne.timestamp,\n           ne.NextOperator,\n           ne.NextEcEvent,\n           ne.NextEcEventTimestamp,\n           ne.CorrectCycle,\n           (\n               SELECT TOP 1 ime.t_put\n               FROM dbo.move_history ime\n               WHERE ime.che_name = ne.cheID\n                 AND ime.t_put < ne.NextEcEventTimestamp\n               ORDER BY ime.t_put DESC\n           ) AS LastMoveEventTimestamp,\n           CASE\n               WHEN ne.CorrectCycle = 'YES' \n               THEN DATEDIFF(MINUTE, ne.timestamp, ne.NextEcEventTimestamp) / 60.0\n               ELSE DATEDIFF(MINUTE, ne.timestamp, \n                    (SELECT TOP 1 ime.t_put \n                     FROM dbo.move_history ime\n                     WHERE (ime.Fetch_CHE_Id = ne.cheID or ime.Put_CHE_Id = ne.cheID)\n                       AND ime.t_put < ne.NextEcEventTimestamp\n                     ORDER BY ime.t_put DESC)) / 60.0\n           END AS TotalWorkinghrs\n    FROM NextEvent ne\n    ORDER BY ne.cheID, ne.timestamp;\nEND\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "malta",
				"poolName": "Built-in"
			},
			"resultLimit": -1
		},
		"type": "SqlQuery"
	}
}